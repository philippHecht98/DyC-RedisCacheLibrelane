graph LR
    subgraph CPU_Space["CPU Memory Map (AXI4-Lite)"]
        direction TB
        A0["0x00: op_reg<br/>(W)"]
        A1["0x04: key_reg<br/>(W)"]
        A2["0x08: value_regs[0]<br/>(W)"]
        A3["0x0C: value_regs[1]<br/>(W)"]
        A4["...<br/>value_regs[N-1]"]
        A5["0x10: status_reg<br/>(R)"]
        A6["0x14: result_regs[0]<br/>(R)"]
        A7["0x18: result_regs[1]<br/>(R)"]
        A8["...<br/>result_regs[N-1]"]
        A9["0x1C: result_index_reg<br/>(R)"]
    end

    subgraph Combinational["Combinational Outputs (always active)"]
        direction TB
        CO1["operation_out<br/>=op_reg[2:0]"]
        CO2["key_out<br/>=key_reg[KEY_WIDTH-1:0]"]
        CO3["value_out<br/>={value_regs[N-1],...,value_regs[0]}"]
        CO4["status_reg<br/>={fsm_state,error,hit,done}"]
    end

    subgraph Controller_Signals["Controller Interface"]
        direction TB
        CS1["start_out<br/>(pulse from FSM)"]
        CS2["done_in<br/>(from controller)"]
        CS3["result_value_in<br/>(from memory)"]
        CS4["hit_in<br/>(from memory)"]
        CS5["result_index_in<br/>(from memory)"]
    end

    %% Write path
    A0 -->|"op_written<br/>triggers FSM"| FSM["Transaction<br/>FSM"]
    A1 --> CO2
    A2 --> CO3
    A3 --> CO3
    A4 --> CO3
    A0 --> CO1

    %% FSM to Controller
    FSM -->|"IF_ST_EXECUTE"| CS1
    CO1 --> CS1
    CO2 --> CS1
    CO3 --> CS1

    %% Controller back to FSM
    CS2 -->|"IF_ST_WAIT"| FSM
    
    %% Results latched from controller
    CS3 -->|"Latch on done_in"| A6
    CS3 -->|"Latch on done_in"| A7
    CS3 -->|"Latch on done_in"| A8
    CS4 -->|"Latch on done_in"| StatusBit["status_hit bit"]
    CS5 -->|"Latch on done_in"| A9

    %% Status composition
    FSM -->|"fsm_state"| A5
    StatusBit -->|"hit"| A5
    FSM -->|"status_done"| A5

    %% Status back to combinational
    A5 --> CO4

    style A0 fill:#ffcccc
    style A1 fill:#ffcccc
    style A2 fill:#ffcccc
    style A3 fill:#ffcccc
    style A4 fill:#ffcccc
    
    style A5 fill:#ccffcc
    style A6 fill:#ccffcc
    style A7 fill:#ccffcc
    style A8 fill:#ccffcc
    style A9 fill:#ccffcc

    style CO1 fill:#ffffcc
    style CO2 fill:#ffffcc
    style CO3 fill:#ffffcc
    style CO4 fill:#ffffcc

    style FSM fill:#ccccff